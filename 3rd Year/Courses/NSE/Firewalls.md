# Firewalls
---
## Notes

A firewall is a computer or network security system that sits between your internal network and the rest of the network. They are used as a barrier through which traffic going in each direction must pass.

The firewall security policy dictates which traffic is authorised to pass in each direction.
It can also perform audits and control access to implement alarms for abnormal behaviour.

They are used to prevent bad things from happening such as:
- Users sending company secrets outside of the internal network
- Outside people breaking into the internal network/system
Or allow good actions to happen such as:
- Allowing employees to access information available externally

They provide NAT (Network Address Translation) and use monitoring. Furthermore they implement VPNs using IPSec.

### Techniques for Firewalls to control access
- Service Control - Determines the types of internet services that can be accessed, inbound or outbound
- Direction Control - Determines the direction in which particular service requests may be initiated and allowed to flow through the firewall
- User Control - Controls access to a service according to which user is attempting to access it
- Behaviour Control - Controls how particular services are used

### Firewall Types
- Positive Filter - Passing only packets that meet specific criteria
- Negative Filter - Rejecting any packets that meet specific criteria

Depending on the firewall, it may examine
- Protocol headers
- Payload of each packet
- The pattern generated by a sequence of packets

#### What it can't do
Can't protect from:
- Attacks bypassing it
- Against malware imported via laptop, PDA, storage infected outside - Sneakernet
- Access via WIFI networks if improperly secured against external use
- Internal threats

##### Sneakernet
This refers to the transfer of electronic information, especially computer files, by physically moving removable media (CDs, USBs) or external hard drives from one computer to another.

### Packet Filtering Firewall
This is a firewall that examines each IP packet (coming and going) and permits or denies the packet according to the rules.

The information in a packet includes:
- Source IP Address
- Destination IP Address
- Source and destination transport level port number (TCP) - this defines applications such as HTTP and DNS
- IP protocol field - This defines the transport protocol

The Firewall will check all of these.

1. Set up firewall with rules based on matches of fields in IP or TCP header
2. Rules applied top to bottom of packet
3. If there is a match to one of the rules, the rule is called to determine whether to forward or discard the packet
4. If there is no match to a rule, default policy is taken

##### Default Policy
There are two types of default policies:
- Discard - This policy is preferred by businesses, as services allowed are added on a case-by-case basis
	- Positive filtering
	- Use a whitelist
	- Whatever is not expressively permitted is prohibited from entry
- Forward - This policy is preferred by users or more open organisations such as universities, the admin must react to each new security threat as it become known
	- Negative filtering
	- Use a blacklist
	- That which is not expressively prohibited is permitted entry

##### Filtering Granularity 
This can be thought as to how frequent are you filtering packets.

You can do this by looking at:
- Input time (for incoming packets)
- Output time (for outgoing packets)
- Both input and output
- Control fields of packets

#### Advantages vs Disadvantages
Advantages:
- Simple to set up
- Transparent to users and are very fast

Disadvantages:
- No examination of upper-layer data , thus no prevention of attacks that employ application-specific vulnerabilities or functions
	- Packet filtering firewalls can't block specific application commands
- Because of limited information available to the firewall, the logging functionality present inn packet filtering firewalls is limited
- Most packet filtering firewalls don't support advanced user authentication schemes

### Firewall Attacks and countermeasures

Packet filtering firewalls are vulnerable to:
- Attacks and exploits that take advantage of problems within TCP/IP specification and protocol stack (network layer address spoofing)
	- Unable to detect a network packet in which IP address has been altered
	- Spoofing attacks are generally employed by intruders to bypass the security controls implemented in a firewall platform
- Security breaches caused by improper configurations
	- It's easy to accidentally configure a packet filtering firewall to allow traffic types, sources, and destinations that should be denied based on an organisations information security policy

1. **IP address Spoofing**
	- Attack
		- Intruder transmits packets from outside with a source IP address containing an address of internal host
		- Attacker hopes that this spoofed address will allow penetration of systems that employ simple source address security, in which packets from specific trusted internal hosts are accepted
	- Countermeasure
		- Add filters on router to block such packets
		- Discard packets with an inside source address if the packet arrives on an external interface
		- Implement these at the router external to the firewall
2. **Source Route Attacking**
	- Attack
		- There's an option for the source node to include information in the packet as to the path the packet should take to get to the destination (note it isn't used much anymore)
		- Attacker generates traffic claiming to be from inside the firewall (although the packet is sent from outside)
		- Attacker specifies the route the packet should take as it crosses the internet, in the hopes that it will bypass security measures that do not analyse the source routing information
	- Countermeasure
		- Block source related packets
		- Discard all packets that use this option
3. **Tiny Fragment Attacks**
	- Attack
		- Attacker uses IP fragmentation option (split header information over several tiny packets) to create extremely small fragments and force the TCP header information into a seperate packet fragment
		- Attack is designed to go around filtering rules that depend on TCP header information
			- Packet filtering firewall typically makes filtering decision on first fragment of a packet
		- Attacker hopes that the filtering firewall examines only the first fragment and that the remaining fragments are allowed through
	- Countermeasure
		- Discard all packets which use the TCP protocol and are fragmented or reassemble before checking
		- Enforce a rule that the first fragment of a packet must contain a predefined minimum amount of the transport header


### Stateful Firewall & Proxy Firewall

#### Stateful Firewall
A traditional packet filtering firewall makes decisions on an individual packet basis, without considering any layer context.

Stateful Packet Filters address this by examining each IP packet in context. Therefore are better at detecting bogus packets out of context.
- Keeping track of client-server sessions (recording information about TCP connections)
- Check each packet valid belongs to on session

###### TCP Port Numbers
In general, when an application that uses TCP creates a session with a remote host, it creates a TCP connection in which,
- TCP port number for a remote (server) application is a number less than 1024 
	- Usually for well known port number. These numbers are assigned permanently to particular applications
- TCP port numbers for a local (client) application is a number between 1024 and 65535 
	- These numbers are generated dynamically and have temporary significance. Only for the lifetime of the TCP connection.

Now a stateful packet inspection firewall tightens up the rules for TCP traffic by creating a directory of outbound TCP connections.
- The packet filter will now allow incoming traffic to high-numbered ports only for those packets that fit the profile of one of the entries in this directory
- A stateful packet inspection firewall reviews the same packet information as a packet filtering firewall, but also records information about TCP connections

- Some of these firewalls also keep track of TCP sequence numbers to prevent attacks that depend on the sequence number, such as TCP session hijacking.
- Some even inspect limited amounts of application data for some well known protocols like FTP and SIP for voice over IP, in order to identify and track related connections.


##### IP Tables
Link: https://linux.die.net/man/8/iptables

This is a popular tool used to setup, maintain, inspect the tables of IP packet filter rules in the Linux kernel.
- Tables
	- This is a general abstraction of the different chains: raw, filter, mangle, nat and security
- Chains
	- Contain a list of defined rules to match against incoming packets. The action to performed is called target (accept or drop)

#### Proxy Firewall 
##### Application-level Gateway
These act as a relay of application-level traffic

It has full access to protocol
1. User contacts gateway using a TCP/IP application, such as Telnet or FTP
2. Gateway asks user for name of remote host to be accessed
3. User responds and provides a valid user ID and authentication information
4. Gateway contacts application on remote host and relays TCP segments containing application data between the two end points

If the does not implement the proxy code for a specific application, then the service is not supported and cannot be forwarded across the firewall.

Therefore the Gateway can be configured to support only specific features of an application that network admin considers acceptable while denying other features.

###### Advantages vs Disadvantages
- Advantages
	- Tend to be more secure than packet filtering firewalls
		- Rather than dealing with the numerous possible combinations that are to eb allowed/forbidden at the TCP and IP level, application-level gateway need only scrutinize a few allowable applications
		- It's easy to log and audit all incoming traffic at the application leve
- Disadvantages
	- Need separate proxies for each service
	- Additional processing overhead on each connection
		- There are two spliced connections between the end users
		- Gateway is at splice point and must examine and forward all traffic in both directions

##### Circuit-level Gateway
These act at the session layer (between the transport and application layer).
- They can be a stand-alone system or specialised function performed by an application-level gateway for certain applications

They set up relays between two TCP connections:
- One between itself and a TCP user on an internal network host
- One between itself and a TCP user on an outside host

Once the two connections are established, gateway typically relays TCP segments from one connection to the other without examining contents.

The security function consists of determining which connections will be allowed.
- Typically used when system admin trusts internal users by allowing general outbound connections
- Gateway can be configured to support application-level proxy service on inbound connections and circuit-level functions for outbound connections
	- Gateway still incurs the processing overhead of examining incoming application data for forbidden functions but does not incur that overhead on outgoing data

### Summary 
![[Pasted image 20230216185856.png]]

---
Backlink: [[NSE Outline]]
